<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Billet Planter</title>
  <link rel="manifest" href="manifest.json?v=3">
  <meta name="theme-color" content="#2a9d8f">
  <style>
    body {font-family: Arial, sans-serif;margin:0;padding:0;background:#f9f9f9;}
    header {background:#2a9d8f;color:white;text-align:center;padding:15px;}
    main {padding:15px;}
    h2,h3 {margin-top:0;}
    .hidden{display:none;}
    form {background:white;padding:15px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);margin-bottom:15px;}
    label {font-weight:bold;display:block;margin-top:10px;}
    input,select,textarea,button{width:100%;padding:12px;margin-top:5px;border-radius:8px;border:1px solid #ccc;font-size:16px;box-sizing:border-box;}
    button{background:#2a9d8f;color:white;font-weight:bold;border:none;margin-top:15px;cursor:pointer;}
    button.secondary{background:#ccc;color:black;}
    #status,#hasilKalibrasi{margin-top:15px;font-weight:bold;font-size:16px;}
    .row2 {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:520px){.row2{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <header><h2>Aplikasi Billet Planter</h2></header>
  <main>
    <div id="menu">
      <button onclick="showPage('inputPage')">üìã Input Data</button>
      <button onclick="showPage('kalibrasiPage')">‚öôÔ∏è Kalibrasi</button>
      <button onclick="showPage('waktuPage')">‚è±Ô∏è Waktu Tunggu</button>
      <button onclick="showPage('harvesterPage')">üåæ Harvester</button>
    </div>

    <!-- Input Data -->
    <div id="inputPage" class="hidden">
      <h3>Form Input Hasil Kerja</h3>
      <form id="workForm">
        <label>Billet Planter:</label>
        <select id="planter" required>
          <option value="">-- Pilih Planter --</option>
          <option value="Planter 1">Planter 1</option>
          <option value="Planter 2">Planter 2</option>
          <option value="Planter 3">Planter 3</option>
          <option value="Planter 4">Planter 4</option>
        </select>
        <label>Nama Karyawan:</label>
        <input type="text" id="nama" required>
        <div class="row2">
          <div>
            <label>Tanggal:</label>
            <input type="date" id="tanggal" required>
          </div>
          <div>
            <label>BIN (Unit):</label>
            <input type="number" id="bin" step="1" value="0">
          </div>
        </div>
        <div class="row2">
          <div>
            <label>Fungisida (L):</label>
            <input type="number" id="fungisida" step="0.01" value="0">
          </div>
          <div>
            <label>Insektisida (Kg):</label>
            <input type="number" id="insektisida" step="0.01" value="0">
          </div>
        </div>
        <label>Pupuk (Kg):</label>
        <input type="number" id="pupuk" step="0.01" value="0">
        <label>Keterangan:</label>
        <textarea id="keterangan"></textarea>
        <button type="submit">‚úÖ Simpan</button>
        <button type="button" class="secondary" onclick="showPage('menu')">‚¨ÖÔ∏è Kembali</button>
      </form>
    </div>

    <!-- Kalibrasi (kalkulator) -->
    <div id="kalibrasiPage" class="hidden">
      <h3>Kalkulator Kalibrasi Fungisida</h3>
      <form id="kalibrasiForm">
        <label>Sisa Air di Tangki (L):</label>
        <input type="number" id="sisaAir" step="0.1" required>
        <label>Dosis Fungisida (L per 1 L air):</label>
        <input type="number" id="dosis" step="0.01" value="0.24" required>
        <button type="submit">üî¢ Hitung</button>
        <button type="button" class="secondary" onclick="showPage('menu')">‚¨ÖÔ∏è Kembali</button>
      </form>
      <div id="hasilKalibrasi"></div>
    </div>

    <!-- Waktu Tunggu (start/end) -->
    <div id="waktuPage" class="hidden">
      <h3>Form Catatan Waktu Tunggu</h3>
      <form id="waktuForm">
        <label>Billet Planter:</label>
        <select id="planterWaktu" required>
          <option value="">-- Pilih Planter --</option>
          <option value="Planter 1">Planter 1</option>
          <option value="Planter 2">Planter 2</option>
          <option value="Planter 3">Planter 3</option>
          <option value="Planter 4">Planter 4</option>
        </select>

        <label>Jenis Kegiatan:</label>
        <select id="jenisWaktu" required>
          <option value="">-- Pilih Jenis --</option>
          <option value="Tunggu Haulout BIN">Tunggu Haulout BIN</option>
          <option value="Troubleshooting">Troubleshooting</option>
          <option value="Tunggu Mekanik">Tunggu Mekanik</option>
          <option value="Isi Planter">Isi Planter</option>
        </select>

        <div class="row2">
          <div>
            <label>Tanggal:</label>
            <input type="date" id="tanggalWaktu" required>
          </div>
          <div></div>
        </div>

        <div class="row2">
          <div>
            <label>Start Time:</label>
            <input type="time" id="startWaktu" required>
          </div>
          <div>
            <label>End Time:</label>
            <input type="time" id="endWaktu" required>
          </div>
        </div>

        <label>Keterangan:</label>
        <textarea id="ketWaktu"></textarea>

        <button type="submit">‚úÖ Simpan</button>
        <button type="button" class="secondary" onclick="showPage('menu')">‚¨ÖÔ∏è Kembali</button>
      </form>
      <p style="font-size:14px;color:#555">Durasi akan dihitung otomatis (menit) di Spreadsheet.</p>
    </div>

    <!-- Harvester -->
    <div id="harvesterPage" class="hidden">
      <h3>Form Data Harvester</h3>
      <form id="harvesterForm">
        <label>Shift:</label>
        <select id="shiftHarv" required>
          <option value="">-- Pilih Shift --</option>
          <option value="Pagi">Pagi</option>
          <option value="Malam">Malam</option>
        </select>

        <div class="row2">
          <div>
            <label>Start Time:</label>
            <input type="time" id="startHarv" required>
          </div>
          <div>
            <label>End Time:</label>
            <input type="time" id="endHarv" required>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>Tanggal Tanam:</label>
            <input type="date" id="tanggalTanam" required>
          </div>
          <div>
            <label>Nomor Blok:</label>
            <input type="text" id="blokHarv" required>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>Varietas:</label>
            <input type="text" id="varietasHarv" required>
          </div>
          <div>
            <label>Luas Area (Ha):</label>
            <input type="number" id="luasHarv" step="0.01" required>
          </div>
        </div>

        <div class="row2">
          <div>
            <label>Jumlah Row Tertebang:</label>
            <input type="number" id="rowHarv" step="1" required>
          </div>
          <div>
            <label>Jumlah BIN Didapatkan:</label>
            <input type="number" id="binHarv" step="1" required>
          </div>
        </div>

        <label>Keterangan:</label>
        <textarea id="ketHarv"></textarea>

        <button type="submit">‚úÖ Simpan</button>
        <button type="button" class="secondary" onclick="showPage('menu')">‚¨ÖÔ∏è Kembali</button>
      </form>
      <p style="font-size:14px;color:#555">Catatan: <b>Total Jam Kerja</b> dihitung otomatis di Spreadsheet.</p>
    </div>

    <p id="status"></p>
  </main>

  <script>
    const status = document.getElementById("status");
    const hasilKalibrasi = document.getElementById("hasilKalibrasi");
    const endpoint = "https://script.google.com/macros/s/AKfycbxaG3jsYQ5xbGo764FuP5XG1rN5EP-ddrRgpa1PbWumgTdsFKR9Nv51RXjj-vlaU3PR/exec"; // ganti dgn URL Web App terbaru

    function showPage(page) {
      for (const id of ["menu","inputPage","kalibrasiPage","waktuPage","harvesterPage"]) {
        document.getElementById(id).classList.add("hidden");
      }
      document.getElementById(page).classList.remove("hidden");
    }

    function saveLocal(data) {
      let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
      offlineData.push(data);
      localStorage.setItem("offlineData", JSON.stringify(offlineData));
    }

    function generateID() {
      return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2,9);
    }

    async function sendData(data) {
      try {
        let response = await fetch(endpoint, { method: "POST", body: JSON.stringify(data) });
        if (response.ok) { status.innerText = "‚úÖ Data terkirim ke server"; return true; }
        else { throw new Error("Gagal"); }
      } catch {
        status.innerText = "üì° Offline, data disimpan sementara";
        saveLocal(data); return false;
      }
    }

    // Input kerja
    document.getElementById("workForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        id: generateID(), type: "kerja",
        planter: planter.value, nama: nama.value, tanggal: tanggal.value,
        fungisida: fungisida.value, insektisida: insektisida.value,
        pupuk: pupuk.value, bin: bin.value, keterangan: keterangan.value
      };
      await sendData(data); e.target.reset();
    });

    // Kalibrasi (kalkulator)
    document.getElementById("kalibrasiForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const totalTangki = 20, sisa = parseFloat(sisaAir.value), dosis = parseFloat(dosis.value);
      const tambahanAir = totalTangki - sisa;
      const perluFungisida = tambahanAir * dosis;
      const perluAir = tambahanAir - perluFungisida;
      hasilKalibrasi.innerHTML = `‚úÖ Tambahkan <b>${perluAir.toFixed(2)} L air</b><br>
        ‚úÖ Tambahkan <b>${perluFungisida.toFixed(2)} L fungisida</b><br>
        üîπ Total campuran tambahan = ${tambahanAir.toFixed(2)} L`;
    });

    // Waktu Tunggu
    document.getElementById("waktuForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        id: generateID(), type: "waktu",
        planter: planterWaktu.value, tanggal: tanggalWaktu.value,
        jenis: jenisWaktu.value, start_time: startWaktu.value, end_time: endWaktu.value,
        keterangan: ketWaktu.value
      };
      await sendData(data); e.target.reset();
    });

    // Harvester
    document.getElementById("harvesterForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        id: generateID(), type: "harvester",
        shift: shiftHarv.value,
        start_time: startHarv.value,
        end_time: endHarv.value,
        tanggal_tanam: tanggalTanam.value,
        blok: blokHarv.value,
        varietas: varietasHarv.value,
        luas_area: luasHarv.value,
        row_tertebang: rowHarv.value,
        bin_didapat: binHarv.value,
        keterangan: ketHarv.value
      };
      await sendData(data); e.target.reset();
    });

    window.addEventListener("online", async () => {
      let offlineData = JSON.parse(localStorage.getItem("offlineData")) || [];
      for (let data of offlineData) { await sendData(data); }
      localStorage.removeItem("offlineData");
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js?v=3")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.log("SW fail:", err));
    }
  </script>
</body>
</html>
